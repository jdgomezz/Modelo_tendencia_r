root <- '~/Agotado_en_gondola'
source(paste0(root, '/source/Load_libs.R'))
Load_libs(root)

RxComputeContext("RxLocalParallel") # Cambiar contexto de ejecución de la máquina a paralelo

# ================ INSTRUCCIONES DE CARGA DE DATOS ======================
# Cargar datos con conexión odbc

#file <- '~/Agotado_en_gondola/querys/query_extraccion_limpieza.txt'
#ventas <- Load_data(file)

# Cargar datos con un read.csv típico
file <- '~/csv/PRUEBA.csv'
ventas <- Load_csv(file)

chars <- characteristics(ventas)
# Cargar datos de venta utilizanzo función de ROpen apartir de un csv y trabajar con una tbala de datos
# con formato xdf

file <- 'csv/PRUEBA.csv'
outfile <- 'xdf/ventas_35.xdf'
venta_35 <- Load_xdf_csv(file, outfile, boolean = FALSE)

# Cargar datos de venta utilizanzo función de R Open a partir de una consulta en Teradata e imprimir
# una tabla de datos con formato xdf
dep <- "41, 54, 75, 33, 35, 31, 568, 4701, 94, 92, 564, 83, 581, 81, 86, 88, 4043, 84, 356, 569" # Dependencia(s)
dep <-"2118, 2119, 2328, 2324, 2327, 1207, 4521, 677, 665, 4259, 148, 7738, 4804, 629, 1209, 172, 4522, 280, 259, 136, 679, 746, 1213, 680, 819, 496, 4181, 4165, 102, 693, 493, 688, 116, 687, 885, 739, 750, 551, 522, 1603, 252, 1109, 1190, 609, 357, 664, 254, 1212, 11, 372, 7736, 920, 691, 4182, 264, 833, 678, 1211, 370, 43, 257, 4800, 1210, 716, 1204, 4706, 538, 4520, 1203, 364, 1206, 4715, 520, 817, 184, 462, 741, 47, 460, 1304, 634, 250, 1311, 715, 4163, 4108, 171, 4810, 836, 4022, 692, 365, 1302, 367, 1108, 690, 4183, 4184, 4150, 1202, 524, 363, 673, 499, 262, 1201, 528, 167, 248, 371, 4036, 14, 1107, 147, 4030, 1102, 366, 44, 914, 4264, 354, 265, 783, 534, 670, 706, 647, 536, 4, 492, 743, 385, 266, 4041, 7737, 1601, 660, 782, 541, 212, 636, 454, 374, 461, 611, 626, 1602, 862, 600, 4161, 489, 68, 535, 488, 939, 1214, 16, 539, 735, 510, 263, 1604, 712, 1208, 4180, 724, 146, 7741, 4807, 699, 748, 4716, 4175, 784, 675, 4162, 4033, 368, 674, 533, 7739, 704, 599, 362, 41, 669, 369, 1106, 19, 654, 4708, 1101, 887, 792, 928, 1110, 661, 1105, 155, 160, 668, 52, 698, 12, 258, 708, 662, 676, 639, 161, 145, 594, 4227, 950, 596, 50, 752, 25019, 4263, 4262, 25028, 4229, 25060, 6190, 912, 4213, 25002, 25016, 3, 7733, 944, 25001, 221, 4024, 25007, 732, 4218, 2615, 666, 4205, 25024, 25053, 4215, 4206, 25018, 435, 4207, 55, 56, 4214, 25012, 4650, 4210, 25003, 25008, 25010, 58, 4230, 25005, 25011, 4216, 540, 25004, 25009, 25013, 25059, 4211, 4256, 4274, 6104, 595, 4212, 6101, 6102, 6107, 933, 25017, 25020, 4219, 751, 757, 25006, 4223, 143, 25056, 4224, 4371, 4592, 501, 222, 25014, 4265, 67, 54, 430, 616, 4208, 593, 53, 598, 650, 134, 4232, 402, 4204, 25026, 4620, 178, 4616, 51, 4023, 620, 4231, 25029, 25058, 4233, 25027, 4225, 422, 25030, 4217, 4226, 25015, 223, 610, 4752, 591, 592, 6106, 6191, 4255, 25023, 25054, 57, 6105, 4261, 403, 4271, 4220, 25057, 612, 25021, 25025, 4228, 415, 25022, 4209, 4222, 4221, 4266, 4267, 9320, 796, 930, 187, 4763, 981, 4791, 9050, 241, 977, 195, 8654, 4793, 1103, 957, 982, 980, 953, 879, 799, 8651, 8653, 4381, 204, 8659, 8655, 202, 974, 203, 971, 9090, 954, 801, 802, 4151, 6248, 8658, 6246, 979, 816, 246, 4886, 4792, 4787, 8660, 421, 247, 242, 951, 249, 4370, 244, 975, 243, 9010, 24, 4035, 909, 952, 972, 960, 32, 9035, 955, 4788, 4762, 9055, 20, 9030, 976, 9015, 9070, 22, 9040, 9075, 906, 806, 948, 153, 231, 810, 9025, 9020, 2316, 7734, 7735, 4795, 9901, 4790, 9060, 900, 4816, 8657, 230, 815, 4382, 572, 4760, 838, 4885, 961, 4880, 978, 305, 962, 4789, 8656, 4481, 973, 4427, 958, 27, 4480, 333, 938, 852, 152, 30, 42, 35, 205, 899, 7512, 176, 4275, 10, 7505, 40, 23, 7502, 342, 516, 736, 373, 855, 848, 453, 482, 943, 2325, 765, 8652, 4028, 731, 505, 625, 486, 507, 169, 4761, 4794, 889, 608, 696, 345, 344, 165, 4138, 4434, 26, 797, 4797, 4796, 827, 898, 500, 759, 7504, 306, 464, 618, 38, 1307, 756, 764, 762, 1301, 523, 2106, 2115, 2102, 2114, 627, 2101, 4111, 2601, 408, 381, 39, 502, 75, 37, 4185, 183, 198, 4110, 4154, 211, 641, 642, 336, 742, 760, 515, 755, 823, 182, 849, 644, 4346, 728, 4177, 4345, 4106, 4168, 4197, 340, 725, 4167, 49, 726, 4152, 48, 197, 656, 109, 514, 4344, 181, 36, 347, 552, 338, 2104, 729, 2110, 98, 452, 2120, 4347, 28, 132, 33, 332, 4335, 4331, 2121, 633, 2113, 4336, 555, 4313, 168, 339, 4801, 4155, 727, 341, 4342, 199, 542, 323, 337, 2107, 2109, 2117, 2122, 2103, 2123, 2116, 5302, 2318, 2326, 484, 5301, 521, 1303, 763, 4311, 730, 793, 1215, 613, 621, 504, 29, 331, 276, 335, 508, 346, 73, 74, 4042, 193, 463, 758, 343, 813, 619, 4614, 615, 141, 466, 465, 201, 4276, 485, 512, 754, 275, 7508, 177, 4040, 384, 409, 31, 45, 95, 856, 1310, 1308, 4988, 614, 382, 509, 8650, 761, 1309, 946, 185, 617, 4989, 924, 2, 808, 4881, 170, 9065, 910, 106, 820, 959, 455, 828, 956, 880, 840, 894, 4815, 25049, 25050, 4302, 25051, 4305, 4243, 4278, 4279, 4244, 4252, 25043, 4304, 4277, 245, 162, 4253, 4280, 4251, 4249, 4303, 25044, 25041, 4273, 839, 4272, 841, 25045, 4268, 25042, 4301, 25047, 25046, 4248, 7730, 25048, 196, 7732, 7731, 138, 947, 63, 4420, 72, 426, 4604, 418, 4250, 425, 25037, 630, 174, 4245, 25031, 624, 4236, 25036, 25034, 25035, 4240, 4270, 4235, 4246, 4241, 4234, 4239, 4247, 480, 789, 228, 4238, 229, 785, 787, 458, 786, 4237, 791, 25033, 4254, 25052, 4242, 25032, 597, 25038, 2179, 25039, 4260, 788, 4603, 4426, 65, 179, 4805, 60, 4418, 603, 62, 66, 140, 420, 428, 424, 628, 383, 334, 4424, 4428, 64, 604, 4628, 427, 4811, 4812, 818, 969, 4031, 6103, 189, 209, 149, 4186, 4160, 968, 744, 79, 253, 934, 194, 13, 326, 128, 317, 7, 8, 9, 151, 71, 180, 580, 574, 319, 4580, 672, 378, 353, 46, 325, 322, 651, 3202, 829, 442, 352, 4441, 4037, 320, 4047, 578, 4574, 3201, 441, 737, 375, 108, 14610, 719, 12227, 390, 4159, 4174, 12253, 734, 497, 12285, 4507, 4025, 127, 110, 12207, 649, 4171, 12110, 494, 273, 256, 12115, 255, 4179, 12301, 4601, 282, 4130, 324, 12222, 657, 723, 12118, 4602, 359, 4189, 301, 87, 8609, 638, 653, 89, 4156, 8601, 327, 4153, 4164, 652, 4169, 8605, 4173, 272, 278, 295, 991, 4122, 966, 637, 188, 4176, 4102, 88, 279, 4157, 4109, 4178, 285, 984, 4187, 4172, 858, 4104, 745, 622, 92, 714, 239, 459, 4482, 235, 81, 284, 4118, 479, 277, 240, 4166, 429, 90, 834, 658, 8608, 8610, 4319, 4188, 659, 4158, 91, 83, 8607, 8603, 237, 303, 937, 8600, 941, 814, 234, 837, 376, 300, 99, 290, 4526, 164, 387, 4506, 915, 4307, 935, 8853, 631, 987, 238, 438, 4029, 842, 233, 689, 738, 8606, 232, 4516, 4519, 605, 4818, 4511, 4049, 487, 126, 4513, 4306, 270, 863, 753, 186, 469, 4043, 4117, 870, 8602, 986, 4509, 394, 7742, 251, 4589, 431, 518, 4105, 107, 587, 82, 104, 4690, 4419, 4806, 517, 4583, 137, 7740, 590, 7743, 299, 7602, 561, 4113, 5102, 558, 142, 4808, 864, 294, 550, 85, 548, 4691, 4588, 7601, 927, 348, 350, 7106, 857, 4586, 936, 349, 4710, 531, 557, 404, 4712, 543, 832, 468, 4703, 564, 4121, 4711, 569, 831, 710, 4707, 4584, 549, 4135, 260, 321, 308, 5101, 7103, 988, 288, 287, 70, 268, 655, 779, 648, 553, 4103, 983, 292, 414, 261, 970, 747, 269, 554, 740, 498, 291, 298, 4141, 271, 309, 296, 645, 304, 457, 778, 4193, 4134, 7104, 4125, 7102, 4136, 4131, 4139, 4116, 4196, 4119, 4115, 4128, 4129, 4190, 4112, 103, 267, 4137, 4191, 4127, 882, 1, 881, 34, 884, 560, 5, 101, 5103, 4195, 967, 6, 559, 117, 417, 775, 643, 312, 4503, 781, 450, 105, 606, 470, 4124, 395, 766, 4515, 790, 400, 607, 397, 4508, 310, 575, 393, 481, 311, 640, 399, 446, 4518, 579, 447, 4314, 709, 4308, 4510, 437, 8249, 623, 451, 448, 8684, 4525, 506, 440, 477, 434, 224, 4501, 985, 8192, 567, 566, 581, 886, 707, 545, 547, 663, 405, 4809, 585, 297, 526, 546, 307, 713, 544, 4504, 4318, 5501, 129, 84, 4194, 682, 4203, 377, 4312, 4502, 97, 4517, 4512, 4309, 356, 4133, 4322, 302, 4258, 4202, 4107, 4320, 4317, 173, 4257, 86, 4140, 700, 392, 471, 396, 733, 407, 511, 157, 419, 4505, 328, 4027, 283, 358, 570, 4046, 379, 386, 78, 175, 69, 330, 219, 159, 4044, 401, 135, 410, 329, 444, 96, 4034, 412, 964, 7105, 584, 586, 4045, 573, 217, 601, 513, 718, 156, 686, 602, 646, 577, 695, 380, 226, 474, 4048, 4514, 589, 439, 473, 225, 476, 433, 4192, 449, 214, 532, 503, 711, 694, 389, 4803, 445, 671, 131, 388, 12254, 355, 4558, 896, 588, 475, 12201, 472, 860, 432, 794, 576, 12240, 150, 391, 703, 571, 12215, 767, 705, 361, 467, 12105, 133, 4553, 4123, 293, 443, 697, 4316, 8235, 416, 12206, 218, 4050, 227, 12204, 158, 4315, 25, 4310, 768, 4704, 989, 12205, 635, 4709, 398, 436, 12246, 769, 154, 519, 7444, 4705, 537, 12203, 582, 166, 423, 562, 12212, 94, 4701, 525, 702, 12108, 563, 701, 568, 12113, 483, 4570, 4132, 4817, 4199, 667, 4713, 4702, 351, 12247, 4714, 236, 4802, 925, 529, 12261, 93, 530, 632, 12102, 965, 565, 12114, 281, 4556, 527, 4813, 12209, 406, 411, 12101, 4201, 861, 8604, 413, 12252, 4198, 883, 163, 456, 717, 478, 4527, 360, 12216, 495, 4554, 4114, 963, 583, 286, 556, 289" # Dependencia(s)
fi <- "'2018-01-01'"                         # Fecha inicial
ff <- "'2018-03-20'"                         # Fecha final
cut_registros <- 0                           # Número mínimo de registro por plu-dep
cut_ultima_venta <- "'2017-11-01'"           # Fecha de última venta realizada
cut_tiempo_vida <- 30                        # Tiempo de vida mínimo por plu-dep ABS(Fecha 1ra venta - Fecha última venta)
cut_proporcion <- 1                          # Proporción de venta mínima (Nro. registros)/(Tiempo de vida)
n_deciles <- 100                             # Nro de deciles a seccionar la muestra

pars <- c(dep, fi, ff, cut_registros, cut_ultima_venta, cut_tiempo_vida, cut_proporcion, n_deciles)
booleano <- TRUE
file <- '~/Agotado_en_gondola/querys/query_extraccion_limpieza.txt'
filename <- 'xdf/ventas.xdf'

venta <- LoadXdf(file, filename, booleano, pars)
rxDataStep(inData = venta, outFile = venta, overwrite = TRUE, transforms = list(Hora_n = as.numeric(Hora)) )

# Cargar datos con un read.csv típico
file <- '~/csv/PRUEBA.csv'
ventas <- Load_csv(file)

# ================ INSTRUCCIONES DE CONSTRUCCION DE CARACTERISTICAS ======================

chars_namefile1 <- "xdf/chs1.xdf"
chars_namefile2 <- "xdf/chs2.xdf"
chars_namefile <- "xdf/characteristics.xdf"
xs <- RxCharacteristics(z = venta, name = chars_namefile, name1 = chars_namefile1, name2 = chars_namefile2)

# =============== INSTRUCCIONES DE CONSTRUCCION DE CARACTERISTICAS ESPECTRALES ============

xs2 <- characteristics_classic(ventas)

# ================ INSTRUCCIONES PARA LA IDENTIFICACIÓN DE PATRONES ======================

conn <- h2o.init(ip = "localhost", port=54321, nthreads = nth, max_mem_size = memo)
h2o.removeAll() # Clean slate - just in case the cluster was already running

model <- cluster_model(xs = xs, k_n = 100, nth = 2, memo ='4g', dep = 35)
